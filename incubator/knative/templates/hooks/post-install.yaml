{{- if .Values.istio.install -}}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: post-installation-job
  namespace: kube-system
  annotations:
      "helm.sh/hook": "pre-install"
      "helm.sh/hook-weight": "0"
      "helm.sh/hook-delete-policy": "hook-succeeded,hook-failed"
spec:
  template:
    metadata:
      name: post-installation-job
    spec:
      serviceAccountName: tiller
      containers:
        # - name: helm
        #   image: dtzar/helm-kubectl:2.9.1 # dtzar/helm-kubectl #linkyard/docker-helm #
        #   command: ["/bin/sh","-c"]
        #   args: [ "wget -qO- https://github.com/istio/istio/archive/{{ .Values.istio.version }}.tar.gz | tar xz;helm del --purge istio;helm install -n istio  istio-{{ .Values.istio.version }}/install/kubernetes/helm/istio --set global.tag={{ .Values.istio.version }} --namespace istio-system" ] #args: ["helm ls"]
        - name:  kubectl
          image: dtzar/helm-kubectl
          command: ["/bin/sh","-c"]  #command: ["kubectl"]
          args: ["kubectl label ns default --overwrite istio-injection=enabled"]
      restartPolicy: OnFailure

---
{{- end -}}




{{- if and .Values.istio.install -}}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: post-deletion-job
  namespace: kube-system
  annotations:
      "helm.sh/hook": post-delete
      "helm.sh/hook-delete-policy": "hook-succeeded,hook-failed"
spec:
  template:
    metadata:
      name: post-deletion-job
    spec:
      serviceAccountName: tiller
      containers:
        - name:  kubectl
          image: dtzar/helm-kubectl
          command: ["/bin/sh","-c"]  #command: ["kubectl"]
          args: ["kubectl label ns default --overwrite istio-injection-;kubectl delete crd --all"]
      restartPolicy: OnFailure
---
{{- end -}}
